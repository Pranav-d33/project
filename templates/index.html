<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retail Forecast Explainability</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">
  <div class="container mx-auto p-6">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-blue-600 mb-2">🛒 Walmart Forecast Explainability</h1>
      <p class="text-lg text-gray-600">Upload your forecast CSV and get AI-powered explanations</p>
    </div>

    <!-- Upload Form -->
    <form action="/upload" method="post" enctype="multipart/form-data" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-6">
      <div class="mb-4">
        <label class="block text-gray-700 text-sm font-bold mb-2" for="file">CSV File</label>
        <input type="file" name="file" id="file" accept=".csv" required 
               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"/>
        <p class="text-sm text-gray-500 mt-1">Maximum file size: 10MB</p>
      </div>
      <div class="flex items-center justify-between">
        <button type="submit" 
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
          📊 Upload & Ingest
        </button>
        <a href="/docs" target="_blank" rel="noopener noreferrer" class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800">
          📚 API Docs
        </a>
      </div>
    </form>

    <!-- Result Section -->
    {% if result %}
    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-6">
      {% if result.error %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" role="alert">
          <strong>❌ Error:</strong> {{ result.error }}
        </div>
      {% else %}
        <h2 class="text-2xl font-semibold mb-4 text-green-600">✅ Ingestion Complete</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-semibold text-gray-700 mb-2">📄 File Info</h3>
            <p><strong>Filename:</strong> {{ result.filename }}</p>
            <p><strong>Total Rows:</strong> {{ result.total_rows }}</p>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-semibold text-gray-700 mb-2">📈 Processing Results</h3>
            <p><strong>Valid Rows:</strong> <span class="text-green-600 font-bold">{{ result.valid_count }}</span></p>
            <p><strong>Invalid Rows:</strong> <span class="text-red-600 font-bold">{{ result.invalid_count }}</span></p>
            <p><strong>Success Rate:</strong> 
              <span class="font-bold {% if result.success_rate >= 90 %}text-green-600{% elif result.success_rate >= 70 %}text-yellow-600{% else %}text-red-600{% endif %}">
                {{ "%.2f"|format(result.success_rate) }}%
              </span>
            </p>
          </div>
        </div>
        
        {% if result.invalid_rows and result.invalid_rows|length > 0 %}
        <details class="mb-4">
          <summary class="font-semibold cursor-pointer text-blue-600 hover:text-blue-800">
            🔍 View Invalid Rows (showing first {{ result.invalid_rows|length }})
          </summary>
          <div class="mt-3 bg-gray-100 border rounded p-4">
            <pre class="text-sm overflow-x-auto whitespace-pre-wrap">{{ result.invalid_rows | tojson(indent=2) }}</pre>
          </div>
        </details>
        {% endif %}

        <!-- Explanation Generation Section -->
        {% if result.valid_count > 0 %}
        <div class="mt-6 pt-6 border-t border-gray-200">
          <h3 class="text-xl font-semibold mb-4 text-purple-600">🤖 AI Explanations</h3>
          <p class="text-gray-600 mb-4">Generate AI-powered explanations for your valid forecast rows using advanced language models.</p>
          
          <div class="flex items-center space-x-4 mb-4">
            <button id="generate-explanations" 
                    class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline disabled:bg-purple-300 disabled:cursor-not-allowed">
              🧠 Generate Explanations
            </button>
            <div id="progress-indicator" class="hidden flex items-center text-blue-600">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span id="progress-text">Generating explanations...</span>
            </div>
          </div>

          <!-- Explanation Configuration -->
          <div class="bg-blue-50 p-4 rounded-lg mb-4" id="explanation-config">
            <h4 class="font-semibold mb-2">⚙️ Configuration</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="batch-size" class="block text-sm font-medium text-gray-700 mb-1">Batch Size</label>
                <select id="batch-size" class="form-select w-full rounded border-gray-300 text-sm shadow-sm">
                  <option value="5">5 rows (Faster)</option>
                  <option value="10" selected>10 rows (Balanced)</option>
                  <option value="20">20 rows (Slower)</option>
                </select>
              </div>
              <div>
                <label for="max-rows" class="block text-sm font-medium text-gray-700 mb-1">Max Rows</label>
                <input type="number" id="max-rows" value="{{ result.valid_count }}" min="1" max="{{ result.valid_count }}" 
                       class="form-input w-full rounded border-gray-300 text-sm shadow-sm">
              </div>
            </div>
          </div>

          <!-- Explanations Output -->
          <div id="explanations-output" class="space-y-4"></div>
        </div>
        {% endif %}
      {% endif %}
    </div>
    {% endif %}

    <!-- API Testing Section -->
    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-6">
      <h2 class="text-2xl font-semibold mb-4 text-indigo-600">🔧 API Testing</h2>
      <p class="text-gray-600 mb-4">Test the explanation API with sample data.</p>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button id="test-single-explanation" 
                class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded disabled:bg-indigo-300 disabled:cursor-not-allowed">
          🧪 Test Single Explanation
        </button>
        <button onclick="window.open('/docs', '_blank', 'noopener,noreferrer')"
                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
          📖 View API Documentation
        </button>
      </div>
      
      <div id="api-test-output" class="mt-4"></div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-gray-500 text-sm mt-8">
      <p>Walmart Demand Forecasting API v1.0.0 | 
         <a href="/health" class="text-blue-500 hover:text-blue-800">Health Check</a> | 
         <a href="/docs" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-800">API Docs</a>
      </p>
    </footer>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // --- Utility Functions ---
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text).replace(/[&<>"']/g, function(match) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[match];
      });
    }

    function displayError(container, message) {
      container.innerHTML = `
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" role="alert">
          <strong>Error:</strong> ${escapeHtml(message)}
        </div>
      `;
    }

    // --- Event Listeners ---

    // Generate explanations from uploaded CSV data
    if (generateBtn && explanationsOutput) {
      generateBtn.addEventListener('click', async () => {
        generateBtn.disabled = true;
        progressIndicator.classList.remove('hidden');
        explanationsOutput.innerHTML = '';

        try {
          const batchSize = parseInt(document.getElementById('batch-size').value, 10) || 10;
          const maxRows = parseInt(document.getElementById('max-rows').value, 10) || validRowsData.length;
          
          if (!validRowsData || validRowsData.length === 0) {
            alert('No valid rows to process.');
            generateBtn.disabled = false;
            progressIndicator.classList.add('hidden');
            return;
          }

          const rowsToProcess = validRowsData.slice(0, maxRows);

          const response = await fetch('/api/explain/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              forecasts: rowsToProcess,
              batch_size: batchSize
            })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: 'Failed to parse error response.' }));
            throw new Error(errorData.detail || `HTTP error! Status: ${response.status}`);
          }

          const data = await response.json();
          displayExplanations(data.explanations || []);

        } catch (error) {
          console.error('Error generating explanations:', error);
          displayError(explanationsOutput, error.message);
        } finally {
          generateBtn.disabled = false;
          progressIndicator.classList.add('hidden');
        }
      });
    }

    // Test single explanation with static data
    if (testBtn && apiTestOutput) {
      testBtn.addEventListener('click', async () => {
        testBtn.disabled = true;
        testBtn.textContent = 'Testing...';
        apiTestOutput.innerHTML = '';

        try {
          const testData = {
            sku_id: "TEST_SKU_001",
            store_id: "TEST_STORE_001",
            forecast_date: "2025-07-11",
            forecast_quantity: 100,
            actual_quantity: 95,
            weather_data: { temperature: 75, precipitation: 0.1 },
            promotional_data: { discount_percent: 10, promotion_type: "SALE" },
            seasonal_data: { season: "SUMMER", holiday_indicator: false }
          };

          const response = await fetch('/api/explain/single', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testData)
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: 'Failed to parse error response.' }));
            throw new Error(errorData.detail || `HTTP error! Status: ${response.status}`);
          }

          const data = await response.json();
          
          apiTestOutput.innerHTML = `
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded" role="alert">
              <h4 class="font-bold mb-2">✅ API Test Successful</h4>
              <pre class="text-sm overflow-x-auto whitespace-pre-wrap">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
            </div>
          `;

        } catch (error) {
          console.error('Error testing API:', error);
          displayError(apiTestOutput, error.message);
        } finally {
          testBtn.disabled = false;
          testBtn.textContent = '🧪 Test Single Explanation';
        }
      });
    }

    // --- Display Functions ---
    function displayExplanations(explanations) {
      if (!explanations || explanations.length === 0) {
        explanationsOutput.innerHTML = '<p class="text-gray-500">No explanations were generated.</p>';
        return;
      }

      const explanationCards = explanations.map(exp => `
        <div class="border p-4 rounded-lg bg-gray-50 shadow-sm">
          <h3 class="font-bold text-lg mb-2 text-gray-800">
            SKU: ${escapeHtml(exp.sku_id)} @ Store: ${escapeHtml(exp.store_id)}
          </h3>
          <p class="mb-3 text-gray-700">
            ${escapeHtml(exp.narrative_explanation || 'No explanation available.')}
          </p>
          <div class="text-sm text-gray-600 space-y-1 mt-3 pt-3 border-t">
            <p><strong>Top Influencer:</strong> 
              <span class="font-medium text-indigo-600">${escapeHtml(exp.top_influencer || 'N/A')}</span>
            </p>
            <p><strong>Confidence:</strong> 
              <span class="font-medium text-indigo-600">${escapeHtml(exp.confidence_score) || 'N/A'}</span>
            </p>
            <p><strong>Type:</strong> 
              <span class="font-medium text-indigo-600">${escapeHtml(exp.explanation_type || 'N/A')}</span>
            </p>
          </div>
        </div>
      `).join('');
      
      explanationsOutput.innerHTML = explanationCards;
    }
  }); // end DOMContentLoaded
  </script>
</body>
</html>